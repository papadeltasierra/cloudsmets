# Notes on the T-ZigBee Implementation of ZigBee2MQTT

Ref:
- [ZigBee development board]
- [ZigBee2MQTT for development board]

## zbhci Notes
- `zbhci` is a protocol between the Espressif ESP32-C3 and the Telink TLSR8258 processors
- communcation is via zbhci_Tx()
    - then uart_send()
- zbhci commands use a CRC8 checksum calculated over the data being sent
- requests(?)/responses from the TLS??? are handled via the `zbhci_task()` which spins calling `uart_recv()` and then unpacking using zbhci_CmdUnpack()
   - `zbhci_CmdUnpack()` does 6 steps, checking the CRC8 as the final step and if that is OK, accepting the request.
   - It is not clear how the protocol recovers from an error as it seems to run through states 0-6 every single time.  It might be possible to improve this or perhaps not!
- `zhbi_Cmdhandler()` processes the message and then passes it along using `xQueueSend()`
    - There are lots of commands, but what do they do?
- `hci_uart.h` seems to be used as the UART - this is written by T-ZigBee and not an Espressif module

### hci_uart Notes
_Pretty standard ESP32 processing_
- Has `init()`/`send()`/`recv()`/`deinit()` methods
- Uses UART_NUM_1
    - **We should be using UART_NUM_2 (0?) to generate debugging and listening in using the serial adapter**
- The usual 115200,8,1,n and not flow control
    - using GPIOs 18 and 19
- Using an ESP32 task to receive data and then send it as an event to the `zbhci` task.

## zhbi Commands
Message types are below.

_These probably relate to ZigBee concepts so we need to read up on the ZigBee protocol._

|Command|Method?|Purpose|
|-|-|-|
|ZBHCI_CMD_BDB_COMMISSION_FORMATION|Y
|ZBHCI_CMD_BDB_COMMISSION_STEER|Y|
|ZBHCI_CMD_BDB_COMMISSION_TOUCHLINK|Y
|ZBHCI_CMD_BDB_COMMISSION_FINDBIND|Y
|ZBHCI_CMD_BDB_FACTORY_RESET|Y
|ZBHCI_CMD_BDB_PRE_INSTALL_CODE|Y
|ZBHCI_CMD_BDB_CHANNEL_SET|Y
|ZBHCI_CMD_BDB_DONGLE_WORKING_MODE_SET|Y
|ZBHCI_CMD_BDB_NODE_DELETE|Y
|ZBHCI_CMD_BDB_TX_POWER_SET|Y
|ZBHCI_CMD_ACKNOWLEDGE|
|ZBHCI_CMD_BDB_COMMISSION_FORMATION_RSP|
|ZBHCI_CMD_NETWORK_STATE_REQ|Y
|ZBHCI_CMD_NETWORK_STATE_RSP|
|ZBHCI_CMD_NETWORK_STATE_REPORT|
|ZBHCI_CMD_DISCOVERY_NWK_ADDR_REQ|Y
|ZBHCI_CMD_DISCOVERY_IEEE_ADDR_REQ|Y
|ZBHCI_CMD_DISCOVERY_NODE_DESC_REQ|Y
|ZBHCI_CMD_DISCOVERY_SIMPLE_DESC_REQ|Y
|ZBHCI_CMD_DISCOVERY_MATCH_DESC_REQ|Y
|ZBHCI_CMD_DISCOVERY_ACTIVE_EP_REQ|Y
|ZBHCI_CMD_DISCOVERY_LEAVE_REQ|Y
|ZBHCI_CMD_DISCOVERY_NWK_ADDR_RSP|
|ZBHCI_CMD_DISCOVERY_IEEE_ADDR_RSP|
|ZBHCI_CMD_DISCOVERY_NODE_DESC_RSP|
|ZBHCI_CMD_DISCOVERY_SIMPLE_DESC_RSP|
|ZBHCI_CMD_DISCOVERY_MATCH_DESC_RSP|
|ZBHCI_CMD_DISCOVERY_ACTIVE_EP_RSP|
|ZBHCI_CMD_BINDING_REQ|Y
|ZBHCI_CMD_UNBINDING_REQ|Y
|ZBHCI_CMD_BINDING_RSP|
|ZBHCI_CMD_UNBINDING_RSP|
|ZBHCI_CMD_MGMT_LQI_REQ|Y
|ZBHCI_CMD_MGMT_BIND_REQ|Y
|ZBHCI_CMD_MGMT_LEAVE_REQ|Y
|ZBHCI_CMD_MGMT_DIRECT_JOIN_REQ|Y
|ZBHCI_CMD_MGMT_PERMIT_JOIN_REQ|Y
|ZBHCI_CMD_MGMT_NWK_UPDATE_REQ|Y
|ZBHCI_CMD_MGMT_LQI_RSP|
|ZBHCI_CMD_MGMT_BIND_RSP|
|ZBHCI_CMD_MGMT_LEAVE_RSP|
|ZBHCI_CMD_MGMT_DIRECT_JOIN_RSP|
|ZBHCI_CMD_MGMT_PERMIT_JOIN_RSP|
|ZBHCI_CMD_MGMT_NWK_UPDATE_RSP|
|ZBHCI_CMD_NODES_JOINED_GET_REQ|Y
|ZBHCI_CMD_NODES_TOGLE_TEST_REQ|Y
|ZBHCI_CMD_TXRX_PERFORMANCE_TEST_REQ|Y
|ZBHCI_CMD_AF_DATA_SEND_TEST_REQ|Y
|ZBHCI_CMD_NODES_JOINED_GET_RSP|
|ZBHCI_CMD_NODES_TOGLE_TEST_RSP|
|ZBHCI_CMD_TXRX_PERFORMANCE_TEST_RSP|
|ZBHCI_CMD_NODES_DEV_ANNCE_IND|
|ZBHCI_CMD_AF_DATA_SEND_TEST_RSP|
|ZBHCI_CMD_LEAVE_INDICATION|
|ZBHCI_CMD_ZCL_ATTR_READ|Y
|ZBHCI_CMD_ZCL_ATTR_WRITE|Y
|ZBHCI_CMD_ZCL_CONFIG_REPORT|Y
|ZBHCI_CMD_ZCL_READ_REPORT_CFG|Y
|ZBHCI_CMD_ZCL_LOCAL_ATTR_READ|Y
|ZBHCI_CMD_ZCL_LOCAL_ATTR_WRITE|Y
|ZBHCI_CMD_ZCL_SEND_REPORT_CMD|Y
|ZBHCI_CMD_ZCL_ATTR_READ_RSP|
|ZBHCI_CMD_ZCL_ATTR_WRITE_RSP|
|ZBHCI_CMD_ZCL_CONFIG_REPORT_RSP|
|ZBHCI_CMD_ZCL_READ_REPORT_CFG_RSP|
|ZBHCI_CMD_ZCL_REPORT_MSG_RCV|
|ZBHCI_CMD_ZCL_LOCAL_ATTR_READ_RSP|
|ZBHCI_CMD_ZCL_LOCAL_ATTR_WRITE_RSP|
|ZBHCI_CMD_ZCL_ATTR_WRITE_RCV|
|ZBHCI_CMD_ZCL_BASIC|
|ZBHCI_CMD_ZCL_BASIC_RESET|Y
|ZBHCI_CMD_ZCL_GROUP|
|ZBHCI_CMD_ZCL_GROUP_ADD|Y
|ZBHCI_CMD_ZCL_GROUP_VIEW|Y
|ZBHCI_CMD_ZCL_GROUP_GET_MEMBERSHIP|Y
|ZBHCI_CMD_ZCL_GROUP_REMOVE|Y
|ZBHCI_CMD_ZCL_GROUP_REMOVE_ALL|Y
|ZBHCI_CMD_ZCL_GROUP_ADD_IF_IDENTIFY|Y
|ZBHCI_CMD_ZCL_GROUP_ADD_RSP|
|ZBHCI_CMD_ZCL_GROUP_VIEW_RSP|
|ZBHCI_CMD_ZCL_GROUP_GET_MEMBERSHIP_RSP|
|ZBHCI_CMD_ZCL_GROUP_REMOVE_RSP|
|ZBHCI_CMD_ZCL_IDENTIFY|
|ZBHCI_CMD_ZCL_IDENTIFY_QUERY|Y
|ZBHCI_CMD_ZCL_IDENTIFY_QUERY_RSP|
|ZBHCI_CMD_ZCL_ONOFF|
|ZBHCI_CMD_ZCL_ONOFF_ON|Y
|ZBHCI_CMD_ZCL_ONOFF_OFF|Y
|ZBHCI_CMD_ZCL_ONOFF_TOGGLE|Y
|ZBHCI_CMD_ZCL_ONOFF_CMD_RCV|
|ZBHCI_CMD_ZCL_LEVEL|
|ZBHCI_CMD_ZCL_LEVEL_MOVE2LEVEL|Y
|ZBHCI_CMD_ZCL_LEVEL_MOVE|Y
|ZBHCI_CMD_ZCL_LEVEL_STEP|Y
|ZBHCI_CMD_ZCL_LEVEL_STOP|Y
|ZBHCI_CMD_ZCL_LEVEL_MOVE2LEVEL_WITHONOFF|Y
|ZBHCI_CMD_ZCL_LEVEL_MOVE_WITHONOFF|Y
|ZBHCI_CMD_ZCL_LEVEL_STEP_WITHONOFF|Y
|ZBHCI_CMD_ZCL_LEVEL_STOP_WITHONOFF|Y
|ZBHCI_CMD_ZCL_SCENE|
|ZBHCI_CMD_ZCL_SCENE_ADD|Y
|ZBHCI_CMD_ZCL_SCENE_VIEW|Y
|ZBHCI_CMD_ZCL_SCENE_REMOVE|Y
|ZBHCI_CMD_ZCL_SCENE_REMOVE_ALL|Y
|ZBHCI_CMD_ZCL_SCENE_STORE|Y
|ZBHCI_CMD_ZCL_SCENE_RECALL|Y
|ZBHCI_CMD_ZCL_SCENE_GET_MEMBERSHIP|Y
|ZBHCI_CMD_ZCL_SCENE_ADD_RSP|
|ZBHCI_CMD_ZCL_SCENE_VIEW_RSP|
|ZBHCI_CMD_ZCL_SCENE_REMOVE_RSP|
|ZBHCI_CMD_ZCL_SCENE_REMOVE_ALL_RSP|
|ZBHCI_CMD_ZCL_SCENE_STORE_RSP|
|ZBHCI_CMD_ZCL_SCENE_GET_MEMBERSHIP_RSP|
|ZBHCI_CMD_ZCL_COLOR|
|ZBHCI_CMD_ZCL_COLOR_MOVE2HUE|Y
|ZBHCI_CMD_ZCL_COLOR_MOVE2COLOR|Y
|ZBHCI_CMD_ZCL_COLOR_MOVE2SAT|Y
|ZBHCI_CMD_ZCL_COLOR_MOVE2TEMP|Y
|ZBHCI_CMD_ZCL_IAS_ZONE|
|ZBHCI_CMD_ZCL_OTA_IMAGE_NOTIFY|Y
|ZBHCI_CMD_DATA_CONFIRM|
|ZBHCI_CMD_MAC_ADDR_IND|
|ZBHCI_CMD_NODE_LEAVE_IND|
|ZBHCI_CMD_AF_DATA_SEND|


[ZigBee development board]: https://www.cnx-software.com/2022/04/27/10-t-zigbee-board-combines-esp32-c3-and-tlsr8258-for-zigbee-3-0-wifi-and-ble-connectivity/
[ZigBee2MQTT for development board]: https://github.com/Xinyuan-LilyGO/
